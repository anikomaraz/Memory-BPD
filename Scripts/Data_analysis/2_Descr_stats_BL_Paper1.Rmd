---
title: "Descr_BPD_memo"
output: html_document
---


```{r get_functions, eval=T, echo=F}
source("../functions_bpd_memo.R")

# load packages
packages <- c("ggplot2", "tidyverse", "lubridate", "data.table", "psych")
load_my_packages(packages)

# user-set options
overwrite_data = TRUE  # if TRUE, then the final data will be saved (overwritten)

```

```{r get_format_data, eval=T, echo=F}
data_final_bl <- read.csv2("../../Data/data_final_bl.csv")

cols_to_factor <- c("gender.sc", "gender.t1", "edu_years_compl.t1", "edu_highest.t1", "SES_subj.t1", "national.t1", 
                    "work.t1", "study.t1", "relationship.t1", "relationship_qual.t1", 
                    "English_first.sc", "English_level.sc", "English_first.t1", "English_level.t1", 
                    "medication.t1", "diagn_bpd.t1")
for (i in cols_to_factor) {
  data_final[, i] <- as.factor(data_final[, i]) 
}

levels(data_final_bl$gender.sc) <- c("1"="female", "2"="male", "3"="other", "4"="I don't want to tell")
levels(data_final_bl$gender.t1) <- c("1"="female", "2"="male", "3"="other", "4"="I don't want to tell")
levels(data_final_bl$edu_highest.t1) <- c("0"="No formal education", "1"="Primary school (or equivalent)", 
                                          "2"="Secondary/high school (or equivalent)", "3"="Vocational school (or equivalent)", 
                                          "4"="Undergraduate school/BA degree (or equivalent)", "5"="Graduate school/MA degree (or equivalent)", 
                                          "6"="PhD/MBA or similar")
levels(data_final_bl$edu_years_compl.t1) <- c("1" = "4 years or less",	"2" =	"5-8 years", 	"3" =	"9-12 years", 
                                              "4" = "12-17 years", "5" = "17-20 years", "6" =	"more than 20 years")
levels(data_final_bl$edu_highest.t1) <- c("0" = "No formal education", "1" =	"Primary school (or equivalent)", 
                                          "2" =	"Secondary/high school (or equivalent)", "3" =	"Vocational school (or equivalent)", 
                                          "4" =	"Undergraduate school/BA degree (or equivalent)", "5" =	"Graduate school/MA degree (or equivalent)", 
                                          "6" =	"PhD/MBA or similar")
levels(data_final_bl$SES_subj.t1) <- c("poorest" =	"Among the poorest", "poorer" =	"Poor", "poor" = "Below average", 
                                       "average" = "Average", 
                                       "rich" = "Above the average",  "richer" =	"Wealthy", "richest"	= "Among the wealthiest")
levels(data_final_bl$work.t1) <- c("1" = "yes, full-time", "2" = "yes, part-time", "3" = "yes, less than part time", "4" = "no")
levels(data_final_bl$study.t1) <- c("1" = "no", "2" = "yes")
levels(data_final_bl$relationship.t1) <- c("1" = "yes", "2" = "no", "3" = "other", "4" = "I don't want to tell")
levels(data_final_bl$relationship_qual.t1) <- c("1" = "married", "2" = "living together", "3" = "not living together", "4" = "I don't want to tell")
levels(data_final_bl$English_first.sc) <- c("1" = "yes", "2" = "no")
levels(data_final_bl$English_first.t1) <- c("1" = "yes", "2" = "no")
levels(data_final_bl$English_level.sc) <- c("1" = "very strong (close to native)", "2" = "strong (fluent)", "3" = "medium (I speak okay)", 
                                            "4" = "weak (I only speak a little)", "5" = "very weak" )
levels(data_final_bl$English_level.t1) <- c("1" = "very strong (close to native)", "2" = "strong (fluent)", "3" = "medium (I speak okay)", 
                                            "4" = "weak (I only speak a little)", "5" = "very weak" )
levels(data_final_bl$medication.t1) <- c("1" = "Yes", "2" = "No")
levels(data_final_bl$diagn_bpd.t1) <- c("1" = "Yes", "2" = "No")


```

```{r describe_demogr, eval=T, echo=T}
# summarise demographic variables
table_descr_demogr <- list(
  "N" = length(data_final_bl$session),
  "age mean" = mean(data_final_bl$age.sc, na.rm=T), 
  "age SD" = sd(data_final_bl$age.sc, na.rm=T),
  "gender" = table(data_final_bl$gender.sc), 
  "gender_percent" = round(prop.table(table(data_final_bl$gender.sc))*100, 2),
  "education_years_completed_percent" = round(prop.table(table(data_final_bl$edu_years_compl.t1))*100, 2),
  "education_percent" = round(prop.table(table(data_final_bl$edu_highest.t1))*100, 2), 
  "SES subjective percent" = round(prop.table(table(data_final_bl$SES_subj.t1))*100, 2), 
  "nationality" = table(data_final_bl$national.t1), 
  "work status percent" = round(prop.table(table(data_final_bl$work.t1))*100, 2),
  "study status percent" = round(prop.table(table(data_final_bl$study.t1))*100, 2),
  "relationship status percent" = round(prop.table(table(data_final_bl$relationship.t1))*100, 2),
  "relationship quality percent" = round(prop.table(table(data_final_bl$relationship_qual.t1))*100, 2),
  "English native percent" = round(prop.table(table(data_final_bl$English_first.sc))*100, 2), 
  "English level percent" = round(prop.table(table(data_final_bl$English_level.sc))*100, 2), 
  "Medication taken?" = round(prop.table(table(data_final_bl$medication.t1))*100, 2), 
  "Borderline diagnosis?" = round(prop.table(table(data_final_bl$diagn_bpd.t1))*100, 2)
  )


# group assigment 
table(data_final_bl$Group.t1)

```

```{r calculate_scales_variables}
## AFFECT GROUPING
data_final_bl$Group_affect <- ifelse(data_final_bl$Group.t1 %in% c("1", "2", "3"), "positive", 
                                  ifelse(data_final_bl$Group.t1 %in% c("4", "5", "6"), "neutral", 
                                         ifelse(data_final_bl$Group.t1 %in% c("7", "8", "9"), "negative", NA)))
data_final_bl$Group_affect <- factor(data_final_bl$Group_affect, levels=c("1" = "positive", "2" = "neutral", "3"="negative"))

## BORDERLINE SCREENING (MSI-BPD)
data_final_bl$BPD_screen <- rowSums(data_final_bl[, grep("^bpd_s\\d+", colnames(data_final), value=T)], na.rm=F)

## MOOD:   CESD, 10 items x5 response => range: 10-50
data_final_bl$CESD.t1 <-  rowSums(data_final_bl[,grep("^cesd_.+.t1", colnames(data_final), value=T)], na.rm=F)

## VIDEO AFFECTS: PANAS 20 items, x7 response => range: 20-140, 10 items for positive, 10 items for negative affect
panas_positive_items <- c("panas_1.t1", "panas_3.t1", "panas_5.t1", "panas_9.t1", "panas_10.t1",
                          "panas_12.t1", "panas_14.t1", "panas_16.t1", "panas_17.t1", "panas_19.t1")
panas_negative_items <- c("panas_2.t1", "panas_4.t1", "panas_6.t1", "panas_7.t1", "panas_8.t1",
                          "panas_11.t1", "panas_13.t1", "panas_15.t1", "panas_18.t1", "panas_20.t1")

# per affect dimension (positive/negative)
data_final_bl[, "PANAS_POS.t1"] <- rowSums(data_final_bl[, panas_positive_items], na.rm = F)
data_final_bl[, "PANAS_NEG.t1"] <- rowSums(data_final_bl[, panas_negative_items], na.rm = F)

#sum score (neg-pos)
data_final_bl[, "PANAS.t1"] <- (data_final_bl[, "PANAS_NEG.t1"] - data_final_bl[, "PANAS_POS.t1"])

# PERSONALITY: IPIP 20 items, x5 response, 5 scales, each range 
bfi_items_recode <- colnames(data_final_bl[, grep("^ipip_.+[0-9]R", colnames(data_final_bl), value=F)])
data_final_bl[, bfi_items_recode] <- (6 - data_final_bl[, bfi_items_recode])
setnames(data_final_bl, names(data_final_bl[, bfi_items_recode]), gsub(pattern="R", replacement="", names(data_final_bl[, bfi_items_recode])))

# compute the scores for the items:
data_final_bl$IPIP_openness <- rowSums(data_final_bl[, grep("^ipip_agree", names(data_final_bl), value=T)], na.rm=F)
data_final_bl$IPIP_conscientiousness <- rowSums(data_final_bl[, grep("^ipip_consc", names(data_final_bl), value=T)], na.rm=F)
data_final_bl$IPIP_extraversion <- rowSums(data_final_bl[, grep("^ipip_extra", names(data_final_bl), value=T)], na.rm=F)
data_final_bl$IPIP_agreeableness <- rowSums(data_final_bl[, grep("^ipip_agree", names(data_final_bl), value=T)], na.rm=F)
data_final_bl$IPIP_neuroticism <- rowSums(data_final_bl[, grep("^ipip_neuro", names(data_final_bl), value=T)], na.rm=F)

## BORDERLINE 2 (BORNOVALOVA ET AL)
data_final_bl$BPD <- rowSums(data_final_bl[, grep("^bpd_\\D{3,}", colnames(data_final_bl), value=T)], na.rm=F)
data_final_bl$BPD_stress <- rowSums(data_final_bl[, grep("^bpd_stress+", colnames(data_final_bl), value=T)], na.rm=F)
data_final_bl$BPD_alien <- rowSums(data_final_bl[, grep("^bpd_alien+", colnames(data_final_bl), value=T)], na.rm=F)
data_final_bl$BPD_control <- rowSums(data_final_bl[, grep("^bpd_contr+", colnames(data_final_bl), value=T)], na.rm=F)
data_final_bl$BPD_aggression <- rowSums(data_final_bl[, grep("^bpd_aggr+", colnames(data_final_bl), value=T)], na.rm=F)
data_final_bl$BPD_wellbeing <- rowSums(data_final_bl[, grep("^bpd_wb+", colnames(data_final_bl), value=T)], na.rm=F)
data_final_bl$BPD_abs1 <- rowSums(data_final_bl[, grep("^bpd_abs_+", colnames(data_final_bl), value=T)], na.rm=F)
data_final_bl$BPD_abs2 <- rowSums(data_final_bl[, grep("^bpd_absExtra_+", colnames(data_final_bl), value=T)], na.rm=F)

## LIFE EVENT CHECKLIST
lec_items.t1 <- c(grep("lec_.+.t1$", names(data_final_bl), value=T))
data_final_bl$LEC_positive.t1 <- ifelse(data_final_bl[ , lec_items.t1] == "1" | data_final_bl[ , lec_items.t1] == "2", T, F)

scales <- c("Group_affect", "LEC_positive.t1", # categoricals
            "BPD_screen", "CESD.t1", "PANAS_POS.t1", "PANAS_NEG.t1", "PANAS.t1", 
            "IPIP_openness", "IPIP_conscientiousness", "IPIP_extraversion", "IPIP_agreeableness", "IPIP_neuroticism", 
            "BPD", "BPD_stress", "BPD_alien", "BPD_control", "BPD_aggression", "BPD_abs1", "BPD_abs2")

## EXTREMITY OF THE RESPONSE
bfi_items <- colnames(data_final_bl[, grep("^ipip_", colnames(data_final_bl), value=F)])
# extr_items <- paste0(rep("extr_", 20), seq(1:20))

for (i in bfi_items) {
  data_final_bl[, paste0("extr_", i)] <- recode(data_final_bl[, i], "1" = 2, "2" = 1, "3" = 0, "4" = 1, "5" = 2)
  }

data_final_bl$EXTR <- rowSums(data_final_bl[, grep("extr_", colnames(data_final_bl), value=T)], na.rm=F)


```


```{r bpd_scale, eval=T, echo=T}



```



```{r describe_scales, eval=T, echo=T}
scales_continous <- c("BPD_screen", "CESD.t1", "PANAS_POS.t1", "PANAS_NEG.t1", "PANAS.t1", 
            "IPIP_openness", "IPIP_conscientiousness", "IPIP_extraversion", "IPIP_agreeableness", "IPIP_neuroticism", 
            "BPD", "BPD_stress", "BPD_alien", "BPD_control", "BPD_aggression", "BPD_abs1", "BPD_abs2", "EXTR")
data_scales_continous <- data_final_bl[, scales_continous]    

descriptive_scales <- data.frame("Mean" = numeric(), "SD" = numeric(), "min" = numeric(), "max" = numeric())
for (i in 1:length(names(data_scales_continous))) {
  newRow <- list(mean(data_scales_continous[, i], na.rm=TRUE),
      sd(data_scales_continous[, i], na.rm=TRUE),
      min(data_scales_continous[, i], na.rm=TRUE),
      max(data_scales_continous[, i], na.rm=TRUE))
      descriptive_scales[names(data_scales_continous[i]), ] <-  newRow
  }
print(round(descriptive_scales, 2))
  
```

```{r save_final_data}

# keep baseline data only
data_final_bl_scales <-  data_final_bl[,grep(".+.t1$|session|.+.sc$|BPD|IPIP|lec_|Group_affect", names(data_final_bl), value=T)]

## save final  data
if (overwrite_data) {
  write.csv2(data_final_bl_scales, file="../../Data/data_final_bl_scales2.csv")
}


```
